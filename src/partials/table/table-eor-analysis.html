<script>
  function eorAnalysisTable() {
    return {
      loadingEorAnalysis: true,
      successLoadingEorAnalysis: true,
      isOpenEorAnalysisForm: false,
      eorAnalysis: null,
      eorAnalysisModelAnalysis: null,
      eorAnalysisFormErrors: {},
      eorAnalysisFormSubmitting: false,
      doFetchEorAnalysis() {
        const id = sessionStorage.getItem("selectedEORId");
        if (!id) {
          console.error("ID EOR tidak ditemukan di sessionStorage");
          this.loaded = false;
          this.isLoadingEor = false;
          return;
        }

        fetch(`${window.apiHost}/eor/${id}/analysis/`, {
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        })
          .then((res) => {
            if (!res.ok) throw new Error("Gagal autentikasi atau fetch data");
            return res.json();
          })
          .then((data) => {
            this.eorAnalysis = data.data;
            if (this.eorAnalysis !== null) {
              this.eorAnalysisModelAnalysis = window.formatJSONArrayToInput(
                this.eorAnalysis.analysis,
              );
            }
            this.loadingEorAnalysis = false;
          })
          .catch((error) => {
            console.error("Gagal memuat EOR Analysis:", error);
            this.loadingEorAnalysis = false;
            this.successLoadingEorAnalysis = false;
          });
      },
      async submitEorAnalysisForm() {
        this.eorAnalysisFormErrors = {};
        if (
          !this.eorAnalysisModelAnalysis ||
          this.eorAnalysisModelAnalysis.trim() === ""
        ) {
          this.eorAnalysisFormErrors.eorAnalysisModelAnalysis =
            "Auditor Analysis harus diisi";
        }

        if (Object.keys(this.eorAnalysisFormErrors).length > 0) return;

        const formattedEorAnalysis = this.eorAnalysisModelAnalysis
          .split("\n")
          .map((line) => line.trim())
          .filter((line) => line !== "");

        this.eorAnalysisFormSubmitting = true;

        // add eor analysis
        if (this.eorAnalysis === null) {
          try {
            const eor_id = this.eor.id;
            const res = await fetch(`${window.apiHost}/eor-analysis`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                eor_id: eor_id,
                analysis: formattedEorAnalysis,
                meeting_type: "RKE",
                meeting_decision: "accepted",
              }),
            });

            const result = await res.json();
            if (!res.ok) {
              await window.swal.fire({
                text: `Gagal membuat: ${result.message || "Terjadi kesalahan."}`,
                icon: "error",
              });
              return;
            }

            await window.swal.fire({
              text: "EOR Analysis berhasil dibuat!",
              icon: "success",
            });

            window.location.href = "/eor.html";
          } catch (error) {
            await window.swal.fire({
              text: "EOR Analysis gagal dibuat!",
              icon: "error",
            });
          }
        }
        // edit eor analysis
        else {
          try {
            const eor_analysis_id = this.eorAnalysis.id;
            const res = await fetch(
              `${window.apiHost}/eor-analysis/${eor_analysis_id}`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({
                  analysis: formattedEorAnalysis,
                }),
              },
            );

            const result = await res.json();
            if (!res.ok) {
              await window.swal.fire({
                text: `Gagal mengedit: ${result.message || "Terjadi kesalahan."}`,
                icon: "error",
              });
              return;
            }

            await window.swal.fire({
              text: "EOR Analysis berhasil diedit!",
              icon: "success",
            });

            window.location.href = "/eor.html";
          } catch (error) {
            await window.swal.fire({
              text: "EOR Analysis gagal diedit!",
              icon: "error",
            });
          }
        }
      },
    };
  }
</script>

<div
  class="overflow-hidden rounded-2xl border border-gray-200 bg-white px-5 pt-4 pb-3 dark:border-gray-800 dark:bg-white/[0.03] dark:[color-scheme:dark]"
  x-data="eorAnalysisTable()"
  x-init="doFetchEorAnalysis()"
>
  <div
    class="mb-3 flex flex-col gap-2 md:flex-row md:items-center md:justify-between"
  >
    <h3 class="text-lg font-semibold text-gray-800 dark:text-white/90">
      Analysis of EOR
    </h3>
  </div>

  <div class="w-full overflow-x-auto">
    <template x-if="loadingEorAnalysis">
      <p class="p-4 text-gray-500 dark:text-gray-400">
        Loading EOR Analysis...
      </p>
    </template>
    <template x-if="!loadingEorAnalysis && successLoadingEorAnalysis === false">
      <p class="p-4 text-gray-500 dark:text-gray-400">Error fetch data</p>
    </template>

    <!-- Header Table -->
    <table
      class="min-w-full table-fixed"
      x-show="!loadingEorAnalysis && successLoadingEorAnalysis === true"
    >
      <thead class="sticky top-0 z-10">
        <tr class="border-y border-gray-100 dark:border-gray-800">
          <th
            class="w-[40px] border border-gray-200 px-2 py-2 dark:border-gray-700"
          >
            <div class="flex items-start justify-center">
              <p
                class="text-theme-xs font-medium text-gray-900 dark:text-gray-300"
              >
                No
              </p>
            </div>
          </th>
          <th
            class="min-w-[500px] flex-1 border border-gray-200 px-2 py-2 dark:border-gray-700"
          >
            <div class="flex items-start justify-center">
              <p
                class="text-theme-xs font-medium text-gray-900 dark:text-gray-300"
              >
                Auditor Analysis
              </p>
            </div>
          </th>
        </tr>
      </thead>

      <tbody class="divide-y divide-gray-100 dark:divide-gray-800">
        <template
          x-if="eorAnalysis !== null && isOpenEorAnalysisForm === false"
        >
          <template
            x-for="(eorAnalysisItem, index) in eorAnalysis.analysis"
            :key="index"
          >
            <tr class="align-top">
              <td
                class="w-[40px] border border-gray-200 px-2 py-2 dark:border-gray-700"
              >
                <div class="flex items-start justify-center">
                  <div
                    class="text-theme-xs font-medium text-gray-900 dark:text-gray-300"
                    x-text="index + 1"
                  ></div>
                </div>
              </td>
              <td
                class="min-w-[300px] flex-1 border border-gray-200 px-2 py-2 dark:border-gray-700"
              >
                <div class="flex flex-col items-start space-y-2">
                  <div
                    class="text-theme-sm font-medium text-gray-800 dark:text-white/90"
                    x-text="eorAnalysisItem"
                  ></div>
                </div>
              </td>
            </tr>
          </template>
        </template>
        <template
          x-if="eorAnalysis !== null && isOpenEorAnalysisForm === false"
        >
          <tr class="align-top">
            <td
              colspan="2"
              class="min-w-[300px] flex-1 border border-gray-200 px-2 py-2 dark:border-gray-700"
            >
              <div class="flex flex-col items-start space-y-2">
                <button
                  class="bg-brand-600 shadow-theme-xs hover:bg-brand-800 inline-flex items-center gap-1.5 rounded-md px-2.5 py-2 text-xs font-medium text-white transition"
                  @click="isOpenEorAnalysisForm = true"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="#ffffff"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34"
                    ></path>
                    <polygon points="18 2 22 6 12 16 8 16 8 12 18 2"></polygon>
                  </svg>
                  Edit EOR Analysis
                </button>
              </div>
            </td>
          </tr>
        </template>

        <template x-if="eorAnalysis !== null && isOpenEorAnalysisForm === true">
          <tr class="align-top">
            <td
              colspan="2"
              class="min-w-[300px] flex-1 border border-gray-200 px-2 py-2 dark:border-gray-700"
            >
              <div class="flex flex-col items-start space-y-2">
                <div class="mt-1 w-full px-1">
                  <div class="w-full">
                    <label
                      class="mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"
                    >
                      EOR Analysis
                    </label>
                    <textarea
                      placeholder="Masukkan EOR Analysis. Satu baris untuk satu item"
                      rows="6"
                      class="shadow-theme-xs focus:border-brand-300 focus:ring-brand-500/10 dark:focus:border-brand-800 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30"
                      x-model="eorAnalysisModelAnalysis"
                    ></textarea>
                    <p
                      x-show="eorAnalysisFormErrors.eorAnalysisModelAnalysis"
                      x-text="eorAnalysisFormErrors.eorAnalysisModelAnalysis"
                      class="text-theme-xs text-error-500 mt-1.5"
                    ></p>
                  </div>

                  <div class="mt-3 mb-3">
                    <button
                      class="shadow-theme-xs mb-2 inline-flex w-full items-center gap-2 rounded-lg bg-red-600 px-4 py-3 text-sm font-medium text-white transition hover:bg-red-800 2xl:mb-0 2xl:w-auto"
                      @click="isOpenEorAnalysisForm = false"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="#ffffff"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                      </svg>
                      Batal
                    </button>

                    <button
                      class="shadow-theme-xs bg-success-600 hover:bg-success-800 mb-2 inline-flex w-full items-center gap-2 rounded-lg px-4 py-3 text-sm font-medium text-white transition 2xl:mb-0 2xl:w-auto"
                      @click="submitEorAnalysisForm()"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="#ffffff"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <path
                          d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"
                        ></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                      </svg>
                      Simpan EOR Analysis
                    </button>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </template>

        <template
          x-if="eorAnalysis === null && isOpenEorAnalysisForm === false"
        >
          <tr class="align-top">
            <td
              colspan="2"
              class="min-w-[300px] flex-1 border border-gray-200 px-2 py-2 dark:border-gray-700"
            >
              <div class="flex flex-col items-start space-y-2">
                <button
                  class="bg-success-600 shadow-theme-xs hover:bg-success-800 inline-flex items-center gap-1.5 rounded-md px-2.5 py-2 text-xs font-medium text-white transition"
                  @click="isOpenEorAnalysisForm = true"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="#ffffff"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                  Buat EOR Analysis
                </button>
              </div>
            </td>
          </tr>
        </template>

        <template x-if="eorAnalysis === null && isOpenEorAnalysisForm === true">
          <tr class="align-top">
            <td
              colspan="2"
              class="min-w-[300px] flex-1 border border-gray-200 px-2 py-2 dark:border-gray-700"
            >
              <div class="flex flex-col items-start space-y-2">
                <div class="mt-1 w-full px-1">
                  <div class="w-full">
                    <label
                      class="mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"
                    >
                      EOR Analysis
                    </label>
                    <textarea
                      placeholder="Masukkan EOR Analysis. Satu baris untuk satu item"
                      rows="6"
                      class="shadow-theme-xs focus:border-brand-300 focus:ring-brand-500/10 dark:focus:border-brand-800 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30"
                      x-model="eorAnalysisModelAnalysis"
                    ></textarea>
                    <p
                      x-show="eorAnalysisFormErrors.eorAnalysisModelAnalysis"
                      x-text="eorAnalysisFormErrors.eorAnalysisModelAnalysis"
                      class="text-theme-xs text-error-500 mt-1.5"
                    ></p>
                  </div>

                  <div class="mt-3 mb-3">
                    <button
                      class="shadow-theme-xs mb-2 inline-flex w-full items-center gap-2 rounded-lg bg-red-600 px-4 py-3 text-sm font-medium text-white transition hover:bg-red-800 2xl:mb-0 2xl:w-auto"
                      @click="isOpenEorAnalysisForm = false"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="#ffffff"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                      </svg>
                      Batal
                    </button>

                    <button
                      class="shadow-theme-xs bg-success-600 hover:bg-success-800 mb-2 inline-flex w-full items-center gap-2 rounded-lg px-4 py-3 text-sm font-medium text-white transition 2xl:mb-0 2xl:w-auto"
                      @click="submitEorAnalysisForm()"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="#ffffff"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <path
                          d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"
                        ></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                      </svg>
                      Simpan EOR Analysis
                    </button>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </template>
      </tbody>
    </table>
  </div>
</div>

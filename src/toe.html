<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>TOE | LSPro BSSN</title>

    <style>
      [x-cloak] {
        display: none !important;
      }
      input[type="date"]::-webkit-calendar-picker-indicator {
        display: none;
      }
      input[type="date"]::-moz-calendar-picker-indicator {
        display: none;
      }
    </style>

    <script defer>
      let token;
      let reviewerData;
      document.addEventListener("alpine:init", () => {
        if (window.isLoggedIn()) {
          token = localStorage.getItem("token");
          reviewerData = JSON.parse(localStorage.getItem("reviewer"));
        } else {
          token = null;
          window.location.href = "/login.html";
        }
      });
      document.addEventListener("alpine:init", () => {
        Alpine.data("TOEPagesInit", () => ({
          // old properties
          page: "toe",
          darkMode: false,
          sidebarToggle: false,

          // new properties
          isLoadingToe: true,
          isLoadingToeSuccess: true,
          isLoadingEor: false,
          isLoadingEorSuccess: true,
          toes: [],
          selectedToe: null,
          isOpenToeModal: false,
          isEditingToe: false,
          isOpenToeReviewerModal: false,
          toeModelTitle: "",
          toeModelVersion: "",
          toeModelEal: "",
          toeFormErrors: {},
          reviewerOptions: [],
          reviewerSelectedAsTOEReviewerIndex: [],
          eors: [],
          isOpenEorModal: false,
          isEditingEor: false,
          eorModelProjectId: "",
          eorModelWorkbookId: "",
          eorModelWorkPackage: "",
          eorModelDeliverablesReference: "",
          eorModelCcComponents: "",
          eorModelWorkbookReleasedDate: "",
          eorFormErrors: {},
          init() {
            this.toes = [];
            this.eors = [];
            this.reviewers = [];
            this.reviewerSelectedAsTOEReviewerIndex = [];
            let toeUrl;
            if (reviewerData.role === "admin") {
              toeUrl = `${window.apiHost}/toe`;
            } else {
              toeUrl = `${window.apiHost}/toe?reviewer_id=${reviewerData.id}`;
            }
            fetch(toeUrl, {
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
            })
              .then((res) => {
                if (!res.ok)
                  throw new Error("Gagal autentikasi atau fetch data");
                return res.json();
              })
              .then(async (data) => {
                await this.doFetchReviewers();
                this.isLoadingToeSuccess = true;
                this.toes = data.data;
                this.isLoadingToe = false;
              })
              .catch((error) => {
                console.error("Gagal memuat TOE:", error);
                this.isLoadingToeSuccess = false;
                this.isLoadingToe = false;
              });
          },
          async doSelectTOE(index) {
            this.selectedToe = this.toes[index];
            const toeId = this.selectedToe.id;
            await this.doFetchEORs(toeId);
          },

          async doFetchReviewers() {
            try {
              const res = await fetch(`${window.apiHost}/reviewer`, {
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
              });
              if (!res.ok) throw new Error("Gagal fetch Reviewer");
              const data = await res.json();

              const reviewers = data.data;

              for (let i = 0; i < reviewers.length; i++) {
                this.reviewerOptions.push({
                  id: reviewers[i].id,
                  value: reviewers[i].id,
                  text: reviewers[i].name,
                  title: reviewers[i].title,
                  selected: false,
                });
              }
            } catch (error) {
              console.error("Gagal memuat Reviewer", error);
              throw new Error("Gagal memuat Reviewer");
            }
          },

          async doFetchEORs(index) {
            try {
              this.eors = [];
              this.reviewerSelectedAsTOEReviewerIndex = [];
              this.isLoadingEor = true;

              const id = this.selectedToe.id;
              const res = await fetch(`${window.apiHost}/toe/${id}/eor`, {
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
              });
              if (!res.ok) throw new Error("Gagal fetch EOR");

              const data = await res.json();

              this.eors = data.data;

              for (let i = 0; i < this.reviewerOptions.length; i++) {
                const selectedAsTOEReviewer = this.selectedToe.reviewers.some(
                  (reviewer) => reviewer.id === this.reviewerOptions[i].id,
                );

                if (selectedAsTOEReviewer) {
                  this.reviewerOptions[i].selected = selectedAsTOEReviewer;
                  this.reviewerSelectedAsTOEReviewerIndex.push(i);
                }
              }

              this.isLoadingEorSuccess = true;
              this.isLoadingEor = false;
            } catch (error) {
              console.error("Gagal memuat EOR:", error);
              this.isLoadingEorSuccess = false;
              this.isLoadingEor = false;
            }
          },

          openToeModal(isEditingToeValue) {
            this.toeFormErrors = {};

            if (isEditingToeValue === true) {
              this.isEditingToe = true;
            } else {
              this.isEditingToe = false;
            }

            this.toeModelTitle = this.isEditingToe
              ? this.selectedToe?.title
              : "";
            this.toeModelVersion = this.isEditingToe
              ? this.selectedToe?.version
              : "";
            this.toeModelEal = this.isEditingToe ? this.selectedToe?.eal : "";
            this.isOpenToeModal = true;
          },

          openToeReviewerModal() {
            this.isOpenToeReviewerModal = true;
          },

          async deleteTOE() {
            const confirmed = await window.swal.fire({
              text: "Apakah kamu yakin ingin menghapus TOE ini?",
              icon: "warning",
              showCancelButton: true,
              confirmButtonColor: "#1d4ed8",
              confirmButtonText: "Ya!",
              cancelButtonColor: "#dc2626",
              cancelButtonText: "Batal",
            });

            if (!confirmed.isConfirmed) return;

            try {
              const id = this.selectedToe.id;
              const res = await fetch(`${window.apiHost}/toe/${id}`, {
                method: "DELETE",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
              });

              const result = await res.json();

              if (!res.ok) {
                await window.swal.fire({
                  text: `Gagal menghapus: ${result.message || "Terjadi kesalahan."}`,
                  icon: "error",
                });
                return;
              }

              await window.swal.fire({
                text: "TOE berhasil dihapus!",
                icon: "success",
              });

              location.reload();
            } catch (error) {
              await window.swal.fire({
                text: "TOE gagal dihapus!",
                icon: "error",
              });
            }
          },

          openEorModal() {
            this.eorFormErrors = {};
            this.isOpenEorModal = true;
          },
        }));
      });
    </script>
  </head>
  <body
    x-data="TOEPagesInit"
    x-init="
         darkMode = JSON.parse(localStorage.getItem('darkMode'));
         $watch('darkMode', value => localStorage.setItem('darkMode', JSON.stringify(value)));
         sidebarToggle = JSON.parse(localStorage.getItem('sidebarToggle'));
         $watch('sidebarToggle', value => localStorage.setItem('sidebarToggle', JSON.stringify(value)));
         "
    :class="{'dark bg-gray-900': darkMode === true}"
  >
    <!-- ===== Page Wrapper Start ===== -->
    <div class="flex h-screen overflow-hidden">
      <!-- ===== Sidebar Start ===== -->
      <include src="./partials/sidebar.html"></include>
      <!-- ===== Sidebar End ===== -->

      <!-- ===== Content Area Start ===== -->
      <div
        class="relative flex flex-1 flex-col overflow-x-hidden overflow-y-auto"
      >
        <!-- ===== Header Start ===== -->
        <include src="./partials/header.html" />
        <!-- ===== Header End ===== -->

        <!-- ===== Main Content Start ===== -->
        <main>
          <div class="mx-auto max-w-(--breakpoint-2xl) p-6">
            <!-- Breadcrumb Start -->
            <div class="mb-6 flex flex-wrap items-center justify-between gap-3">
              <h2
                class="text-xl font-semibold text-gray-800 dark:text-white/90"
              >
                TOE
              </h2>
            </div>
            <!-- Breadcrumb End -->

            <!-- ====== Form Elements Section Start -->
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
              <div class="space-y-6">
                <div
                  class="overflow-hidden rounded-2xl border border-gray-200 bg-white px-5 pt-4 pb-3 dark:border-gray-800 dark:bg-white/[0.03]"
                >
                  <div
                    class="mb-4 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between"
                  >
                    <div class="mt-3 mb-3">
                      <h3
                        class="text-lg font-semibold text-gray-800 dark:text-white/90"
                      >
                        Daftar TOE
                      </h3>
                    </div>
                    <button
                      class="bg-success-600 shadow-theme-xs hover:bg-success-800 inline-flex items-center gap-2 rounded-lg px-4 py-3 text-sm font-medium text-white transition"
                      @click="openToeModal(false)"
                      x-show="!isLoadingToe && isLoadingToeSuccess && reviewerData?.role === 'admin'"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="#ffffff"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                      </svg>
                      Tambah TOE
                    </button>
                  </div>

                  <div class="w-full overflow-x-auto dark:[color-scheme:dark]">
                    <!-- Header Table -->
                    <table class="min-w-full table-fixed">
                      <thead class="sticky top-0 z-10">
                        <tr
                          class="border-y border-gray-100 dark:border-gray-800"
                        >
                          <th class="w-[50px] py-3 text-center">
                            <div class="flex items-center justify-center">
                              <p
                                class="text-theme-xs font-medium text-gray-900 dark:text-gray-300"
                              >
                                No
                              </p>
                            </div>
                          </th>
                          <th class="py-3">
                            <div class="flex items-start">
                              <p
                                class="text-theme-xs font-medium text-gray-900 dark:text-gray-300"
                              >
                                TOE
                              </p>
                            </div>
                          </th>
                        </tr>
                      </thead>
                    </table>

                    <!-- Scrollable Body -->
                    <div class="max-h-[300px] overflow-y-auto">
                      <template x-if="isLoadingToe">
                        <p class="p-4 text-gray-500 dark:text-gray-400">
                          Loading TOE...
                        </p>
                      </template>
                      <template
                        x-if="!isLoadingToe && isLoadingToeSuccess === false"
                      >
                        <p class="p-4 text-gray-500 dark:text-gray-400">
                          Error saat mengambil data TOE.
                        </p>
                      </template>
                      <template
                        x-if="!isLoadingToe && isLoadingToeSuccess && toes.length === 0"
                      >
                        <p class="p-4 text-gray-500 dark:text-gray-400">
                          Belum ada data TOE.
                        </p>
                      </template>

                      <table
                        class="min-w-full table-fixed"
                        x-show="!isLoadingToe && toes.length > 0"
                      >
                        <tbody
                          class="divide-y divide-gray-100 dark:divide-gray-800"
                        >
                          <template x-for="(toe, index) in toes" :key="index">
                            <tr
                              class="cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800"
                              @click="doSelectTOE(index)"
                            >
                              <td class="w-[50px] py-3">
                                <div
                                  class="text-theme-sm flex items-center justify-center font-medium text-gray-800 dark:text-white/90"
                                  x-text="index + 1"
                                ></div>
                              </td>
                              <td class="py-3">
                                <div
                                  class="text-theme-sm flex items-start font-medium text-gray-800 dark:text-white/90"
                                  x-text="toe.title"
                                ></div>
                              </td>
                            </tr>
                          </template>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <div class="space-y-6" x-show="selectedToe !== null">
                <div
                  class="mb-6 rounded-2xl border border-gray-200 bg-white p-5 dark:border-gray-800 dark:bg-white/[0.03]"
                >
                  <div
                    class="flex flex-col gap-6 2xl:flex-row 2xl:items-start 2xl:justify-between"
                  >
                    <div>
                      <h4
                        class="mb-6 text-lg font-semibold text-gray-800 dark:text-white/90"
                      >
                        Informasi TOE
                      </h4>

                      <div class="grid gap-4">
                        <div x-transition>
                          <p
                            class="mb-1 text-xs leading-normal text-gray-500 dark:text-gray-400"
                          >
                            TOE Title
                          </p>
                          <template x-if="selectedToe">
                            <div
                              class="text-sm font-medium text-gray-800 dark:text-white/90"
                              x-text="selectedToe.title"
                            ></div>
                          </template>
                          <template x-if="!selectedToe">
                            <p
                              class="text-sm font-medium text-gray-800 dark:text-white/90"
                            >
                              (null)
                            </p>
                          </template>
                        </div>

                        <div>
                          <p
                            class="mb-1 text-xs leading-normal text-gray-500 dark:text-gray-400"
                          >
                            TOE Version
                          </p>
                          <template x-if="selectedToe">
                            <div
                              class="text-sm font-medium text-gray-800 dark:text-white/90"
                              x-text="selectedToe.version"
                            ></div>
                          </template>
                          <template x-if="!selectedToe">
                            <p
                              class="text-sm font-medium text-gray-800 dark:text-white/90"
                            >
                              (null)
                            </p>
                          </template>
                        </div>

                        <div>
                          <p
                            class="mb-1 text-xs leading-normal text-gray-500 dark:text-gray-400"
                          >
                            EAL
                          </p>
                          <template x-if="selectedToe">
                            <div
                              class="text-sm font-medium text-gray-800 dark:text-white/90"
                              x-text="selectedToe.eal"
                            ></div>
                          </template>
                          <template x-if="!selectedToe">
                            <p
                              class="text-sm font-medium text-gray-800 dark:text-white/90"
                            >
                              (null)
                            </p>
                          </template>
                        </div>
                        <div>
                          <p
                            class="mb-1 text-xs leading-normal text-gray-500 dark:text-gray-400"
                          >
                            TOE Reviewer
                          </p>
                          <div
                            class="flex flex-col items-center items-start gap-1"
                          >
                            <template
                              x-if="selectedToe && selectedToe.reviewers.length > 0"
                            >
                              <div
                                class="flex flex-col items-center items-start gap-1"
                              >
                                <div
                                  class="text-theme-xs text-brand-600 rounded-full px-2 py-0.5 font-medium"
                                  :class="selectedToe.reviewers.find(reviewer => reviewer.toe_reviewer_is_lead_reviewer === true).is_active
                                ? 'bg-brand-100 p-4 text-brand-600 dark:bg-brand-500/15 dark:text-brand-500'
                                : 'bg-red-100 p-4 text-red-600 dark:bg-red-500/15 dark:text-red-500'"
                                  x-text="`[Lead Auditor] ${selectedToe.reviewers.find(reviewer => reviewer.toe_reviewer_is_lead_reviewer === true).name}`"
                                ></div>
                                <template
                                  x-for="(reviewer, index) in selectedToe.reviewers.filter(r => r.toe_reviewer_is_lead_reviewer === false)"
                                >
                                  <div
                                    class="text-theme-xs text-success-600 rounded-full px-2 py-0.5 font-medium"
                                    :class="reviewer.is_active
                                ? 'bg-green-100 p-4 text-success-600 dark:bg-success-500/15 dark:text-success-500'
                                : 'bg-red-100 p-4 text-red-600 dark:bg-red-500/15 dark:text-red-500'"
                                    x-text="reviewer.name"
                                  ></div>
                                </template>
                              </div>
                            </template>
                            <template
                              x-if="selectedToe && selectedToe.reviewers.length === 0"
                            >
                              <p
                                class="mb-0.5 text-sm font-medium text-gray-500 dark:text-gray-400"
                              >
                                Belum ada TOE Reviewer.
                              </p>
                            </template>
                          </div>
                        </div>
                      </div>
                      <div
                        class="mt-6 flex flex-col gap-2 2xl:flex-row 2xl:items-start"
                      >
                        <button
                          class="shadow-theme-xs bg-brand-600 hover:bg-brand-800 inline-flex w-full items-center gap-2 rounded-lg px-4 py-3 text-sm font-medium text-white transition 2xl:w-auto"
                          @click="openToeModal(true)"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="#ffffff"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          >
                            <path
                              d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34"
                            ></path>
                            <polygon
                              points="18 2 22 6 12 16 8 16 8 12 18 2"
                            ></polygon>
                          </svg>
                          Edit TOE
                        </button>
                        <button
                          class="shadow-theme-xs bg-warning-600 hover:bg-warning-800 inline-flex w-full items-center gap-2 rounded-lg px-4 py-3 text-sm font-medium text-white transition 2xl:w-auto"
                          @click="openToeReviewerModal()"
                          x-show="selectedToe?.reviewers?.length === 0 && reviewerData?.role == 'admin'"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="#ffffff"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          >
                            <path
                              d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"
                            ></path>
                            <circle cx="8.5" cy="7" r="4"></circle>
                            <polyline points="17 11 19 13 23 9"></polyline>
                          </svg>
                          Tentukan TOE Reviewer
                        </button>
                        <button
                          class="shadow-theme-xs inline-flex w-full items-center gap-2 rounded-lg bg-red-600 px-4 py-3 text-sm font-medium text-white transition hover:bg-red-800 2xl:w-auto"
                          @click="deleteTOE()"
                          x-show="reviewerData?.role == 'admin'"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="#ffffff"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          >
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path
                              d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                            ></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                          </svg>
                          Hapus TOE
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <div
                  class="overflow-hidden rounded-2xl border border-gray-200 bg-white px-5 pt-4 pb-3 dark:border-gray-800 dark:bg-white/[0.03]"
                >
                  <div
                    class="mb-3 flex flex-col gap-2 md:flex-row md:items-center md:justify-between"
                  >
                    <h3
                      class="text-lg font-semibold text-gray-800 dark:text-white/90"
                    >
                      Daftar EOR
                    </h3>
                    <button
                      class="bg-success-600 shadow-theme-xs hover:bg-success-800 inline-flex items-center gap-1.5 rounded-md px-2.5 py-1 text-xs font-medium text-white transition"
                      @click="openEorModal()"
                      x-show="!isLoadingEor && isLoadingEorSuccess && selectedToe?.reviewers?.length !== 0"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="#ffffff"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                      </svg>
                      Tambah EOR
                    </button>
                  </div>

                  <div class="w-full overflow-x-auto">
                    <!-- Header Table -->
                    <table class="min-w-full table-fixed">
                      <thead class="sticky top-0 z-10">
                        <tr
                          class="border-y border-gray-100 dark:border-gray-800"
                        >
                          <th class="sticky left-0 z-20 w-[50px] py-1">
                            <div class="flex items-center justify-center">
                              <p
                                class="text-theme-xs font-medium text-gray-900 dark:text-gray-300"
                              >
                                No
                              </p>
                            </div>
                          </th>
                          <th class="py-1">
                            <div class="flex items-center">
                              <p
                                class="text-theme-xs font-medium text-gray-900 dark:text-gray-300"
                              >
                                EOR
                              </p>
                            </div>
                          </th>
                        </tr>
                      </thead>
                    </table>

                    <!-- Scrollable Body -->
                    <div class="max-h-[300px] overflow-y-auto">
                      <template x-if="isLoadingEor">
                        <p class="p-4 text-gray-500 dark:text-gray-400">
                          Loading EOR...
                        </p>
                      </template>
                      <template
                        x-if="!isLoadingEor && isLoadingEorSuccess === false"
                      >
                        <p class="p-4 text-gray-500 dark:text-gray-400">
                          Error saat mengambil data EOR.
                        </p>
                      </template>
                      <template
                        x-if="!isLoadingEor && isLoadingEorSuccess && eors.length === 0"
                      >
                        <p class="p-4 text-gray-500 dark:text-gray-400">
                          Belum ada EOR.
                        </p>
                      </template>

                      <table class="min-w-full table-fixed">
                        <tbody
                          class="divide-y divide-gray-100 dark:divide-gray-800"
                          x-show="!isLoadingEor && eors.length > 0"
                        >
                          <template x-for="(eor, index) in eors" :key="index">
                            <tr
                              class="cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800"
                              @click="
                              sessionStorage.setItem('toeId', selectedToe.id);
                              sessionStorage.setItem('selectedEORId', eor.id);
                              window.open('/eor.html', '_self')"
                            >
                              <td class="w-[50px] py-1">
                                <div
                                  class="text-theme-sm flex items-center justify-center font-medium text-gray-800 dark:text-white/90"
                                  x-text="index + 1"
                                ></div>
                              </td>
                              <td class="py-1">
                                <div
                                  class="text-theme-sm flex items-start font-medium text-gray-800 dark:text-white/90"
                                  x-text="'[' + eor.work_package + '] ' + eor.workbook_id"
                                ></div>
                              </td>
                            </tr>
                          </template>
                          <!-- Tambah row lainnya -->
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- ====== Form Elements Section End -->
          </div>
        </main>
        <!-- ===== Main Content End ===== -->
      </div>
      <!-- ===== Content Area End ===== -->
    </div>
    <!-- ===== Page Wrapper End ===== -->

    <div x-show="isOpenToeModal === true" x-cloak>
      <include src="./partials/toe-modal.html" />
    </div>
    <div x-show="isOpenToeReviewerModal === true" x-cloak>
      <include src="./partials/toe-reviewer-modal.html" />
    </div>
    <div x-show="isOpenEorModal === true" x-cloak>
      <include src="./partials/eor-modal.html" />
    </div>
  </body>
</html>
